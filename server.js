/*****************************************************************************************************************************************************
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
      .!! .!!.             .!; :!.              '$;               .'      .....`.          '|'    :%:       .'     !!               .!:     :%'      `
      !@: !#%;;:;;;;'      !@:  !@:!#####$`  .;|$#&|'!#!|&|!!&$`  .|#%.  ;#$:':$@:    :@################$`   '$&'`$#@#######$'      `$|     ;@:      `
     !@: ;#|..   .`|%.    !@:.%%.       !&`     '@! !#; |%. !#;      ``  !@:   !@:         !#;    !#;          .'!'  ;#|  !#!   .%%.`$! !##@##@@##|  `
    |#| ;#!   !$' !@:   .%#|  |%.       !$` .;|!%#&&#$:'|%.'$!   :@$`  `%@:    :@##@: .!@##@&@####@@###@;   `$#!  .|#$`'&@;      |$``$! !$' ;&: `&!  `
  :@%%%... `. !$``'    !#|%%. |%.       !$'     `$&'   .%| !&'     '&|  .             `%|             .%|   '.  `!:       .;$!   |%.`$! !&' ;&: `$!  `
     |%.  !&' !$'`%|     .%%..%%.       |&'  `%#######: |%. ;@;        `$#@$$$$%&#%.    `'''':$&;'''''`      '&##@#@&&#####!     |%.`$! !&' ;@: '&!  `
     |$. ;#!  !&' :@!    .%%..%%        |&' `':$!   :@!.%%.  ;@:    !#;  :&|   '&|.      ....:&|....`%$`     '&|   `$|   '&!    .%%.'&! !&' ;@: `$!  `
     |%.:@!   |$`  !&'   .%%..%%.       !$`   `$#@@@##;.%%.  |@:   ;@;     !@%$&'           .%|     .|%.     '&|   !@:   '&!        !$` !&' ;&: :&!  `
     |%.`'    !&'  .|:   .%%..%%.       !$'   '&|   ;@!.%|.:;`    ;#!    .;@#&@@!.        :&@:      ;@!          :&&':@#@!.       `%$`  ';. !&:`;`   `
    .|$`  .|###;         .%%..%%.    ;##@:    '&$;::%#!.%%.      .!;  '&#%'     .|@#!  |#$:     |###&'     .%###%:        ;&#;   |@:        !#;      `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                                                                                                                                     `
                                              .''`                 `'`              `.                                                               `
                                            :||::|%;.          `;%%!|!` .':;!!!|%$%|!|%:                                                             `
                                          '||`     ;%!.    `!$%!'   ;$$|;:`..        `!;```'`.    '!%%%%|%|'                                         `
                                         `|;        .!|`.:%|'     '%|`              '%%!;;;;;!|%&%:.      ;|'                                        `
                                         ;!`          ;%%!`                                   .!!.        '|:                                        `
                                        :|:    ';.    `%|.                                  '&#$`  .;$%:  :|:                                        `
                                        '|'   .'|!.    ;|`                                      :%%|:'`.  ;|`                                        `
                                        '!:   .':|;    ;|'                                     .:%$%:..  '|;.                                        `
                                        `!:   .'';|'   ;%'                                          :%!``!;.                                         `
                                       `:||'   .'!%:   .`                                             .|@|`                                          `
                                     .!%;:%%`   .:`                                                      `;%$$;                                      `
                                     `!!`  '%;                                                              .!!.                                     `
                                 ';|%%%:                                               `:!||%%%%%%|||!!!;;;!$&|;;::`                                 `
                               '|!.           .`'':;;!!!!|||%$&&&&&@@@@@@@@@@@###@@@@&@##@@@@@@@@@@@@@@#####@@@####%`                                `
                               `!!.           `%#####@@@##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##&;.                                `
                               '!$|.    `:!%&####@@@@@@@@@@@@@@@@@@@@@@@@@@@@#@@&$%!!!!%@@@@@@@@@@@@@@@@@@@@#@@@#@%'`''                              `
                              `|!.  '%@##@&$%|!:!&#@@@@@@@@@@@@@@@@@@@@@@@@@##&: .`.   .;$@@@@@@@@@@@@@@@@@@@@@@@#%`;@#|'                            `
                              `|&!`!#&:          `%##@@@@@@@@@#@@@@@@@@@@@@##%` ..        ;&#@@##@@@@@@@@@@@@@@#&!!&@@##&!.                          `
                             '|:    .              ;&#@@@@@@@@@@@@@@@@@@@##$`               '%@##@@@@@@@@@@##@@@@##@@@@@@#&;.                        `
                            `!&&;                    '%@###@@@@@@@@@@@@@@|`                .`. .:%@@@####@&|' :&@###@@#####&;                        `
                          '|%'                          .:%&@@@@##@@@%;.    `'`              .`.              `%@#@###@|'  |@!                       `
                          .!$;                                           .:;'..              ..```.           .|@$|;`      .%&:                      `
                            .|@;                                     `':!|;.   .'!%$$|;;!%$|'`'::`.           .||`          '&$`                     `
                            `|$'                                     .:;:.          ';||!:`    .`.            .|%`          .|&:                     `
                            :%:                                       ..`.        .```                        .%%`           !&!.                    `
                           `%|.                                         .`:;!!!!;;!;:``':::;:'.               `$%.           !&!.                    `
                          .!$'                                          .``.          ..'!!'.                 :&|.           !&!.                    `
                          ;$;                                          ....  .``.               .            .|&:           .|&;                     `
                         :$|.                                           ...     .';;:''''::'.                '$%`           '$$'                     `
                        :$|.                                                       `:!!;;;'.                .%&:            !@!.                     `
                       ;&!                                                                                  !&;            '&$'                      `
                      ;&!                                                                                  ;&%.           `%&:                       `
                    .!@!                                                                                  ;@|.           .%&;                        `
                   `%@!                                                                                 .|@|.           .%@;                         `
                  '&&'                                                                                 `$@;            `$@;                          `
                 .%%.                                                                                  .`            .;&$'                           `
                                                                                                                    `$@!`                            `
                                                                                                                  '$#%`                              `
                                                                                                               .:$#$'.                               `
                                                                                                             :&#&||!.                                `
                                                                                                              `|$$|'                                 `
                                                                                                              `|:                                    `
                                                                                                              '|:                                    `
                                                                                                             .;|'                                    `
                                                                                                           .:!%:                                     `
                                                                                                           :$$!.                                     `
                                                                                                       .;'.|@|.                                      `
                                                                                                       `;:!$;                                        `
                                                                                                       :&#&:                                         `
                                                                                                      '&&;                                           `
                                                                                                    .;@&:                                            `

 ****************************************************************************************************************************************************/


const express=require('express');
const cookieParser=require('cookie-parser');
const cookieSession=require('cookie-session');
const bodyParser=require('body-parser');
const mysql=require('mysql');
const forge=require('node-forge')


const pathLib=require('path');
const fs=require('fs');

const multer=require('multer');
const multerObj=multer({dest:'./public/images'});



/*********************************************************************************************************************
 * 此处的作用是初始化服务器各种工具的配置
 ********************************************************************************************************************/

/**
 * mysql连接池，设置了mysql各种配置信息，用户可以根据自己实际情况进行修改
 */
const db=mysql.createPool({
    host: 'localhost',
    user: 'root',
    password: '741258',
    database: 'bgk_blog',
    timezone:"08:00"
});



/**
 * 创建名叫server的服务器，并且让此服务器监听8888端口，用户可以在这里设定自己喜欢的端口号
 */
var server=express();
server.listen(8888);



/**
 * 解析cookies，cookieParser（）里面的内容你喜欢写什么就写什么，越复杂越好
 */
server.use(cookieParser('sdfasl43kjoifguokn4lkhoifo4k3'));



/**
 * 使用session，配置session，设置session持续时间为2小时，在这里你可以设置用户登陆有效时间
 */
var arr=[];
for(var i=0;i<100000;i++){
    arr.push('keys_'+Math.random());
}
server.use(cookieSession({name: 'bgk_session_id', keys: arr, maxAge: 2*60*60*1000,path:"http://localhost"}));


/**
 * 设定post，最大post最大限制为10mb，可以在此设定上传文件最大容量
 */
server.use(bodyParser.urlencoded({extended: false,limit:'10mb'}));



server.use(multerObj.any());





server.use('/public',express.static('public'))



/*********************************************************************************************************************
 * 从这里开始就各种是正式的api接口了
 ********************************************************************************************************************/






/************************************首页界面*******************************************/

/**
 * 接口：homeArticleList'
 * UI位置：首页
 * 功能：从数据库里的article_table读取所有留言的ID（文章ID），article_title（文章标题），
 *      article_summary（文章简介），article_push_time（文章发表时间）并返回到请求端
 * 效果：让“首页”界面列出所有文章标题、文章简介和文章发表时间
 */
server.get('/homeArticleList', (req, res)=>{
    db.query("SELECT ID,article_title,article_summary,article_type,article_push_time FROM article_table ORDER BY ID DESC LIMIT 10",(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});




/************************************文章界面*******************************************/

/**
 * 接口：getArticleList'
 * UI位置：文章
 * 功能：从数据库里的article_table读取前台传上来的特定分类的ID（文章ID），article_title（文章标题），article_push_time（文章发表时间）并返回到请求端
 * 效果：如果前台发来的数据为‘all’，则让“文章”界面列出所有、文章ID、文章标题和文章发表时间
 *      否则会根据前台发来的其他数据，显示出特定分类的、文章ID、文章标题和文章发表时间
 */
server.get('/getArticleList', (req, res)=>{
    var id=req.query.tabid;
    if(id=='all'){
        db.query(`SELECT ID,article_title,article_type,article_push_time FROM article_table  ORDER BY ID DESC`,(err,data)=>{
            if(err){
                console.error(err);
                res.status(500).send(err).end();
            }else{
                res.json(data);
            }
        });
    }
    else{
        db.query(`SELECT ID,article_title,article_type,article_push_time FROM article_table WHERE article_type='${id}'  ORDER BY ID DESC`,(err,data)=>{
            if(err){
                console.error(err);
                res.status(500).send(err).end();
            }else{
                res.json(data);
            }
        });
    }
});



/**
 * 接口：/getArticles
 * UI位置：文章 || 后台=》修改文章
 * 功能：读取前台发上来的ID，从数据库里的article_title读取该ID的所有内容，并返回到请求端
 * 效果：让“文章 || 后台=》修改文章”这两个界面列出某个文章的所有内容
 */
server.get('/getArticles', (req, res)=>{
    var id=req.query.id;
    db.query(`SELECT * FROM article_table WHERE ID=${id} ORDER BY ID DESC`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});




/************************************留言板界面*******************************************/

/**
 * 接口：getMessage
 * UI位置：留言板
 * 功能：从数据库里的message_table读取所有信息（留言），并返回到请求端
 * 效果：让留言板显示出所有留言信息
 */
server.get('/getMessage', (req, res)=>{
    db.query("SELECT * FROM message_table ORDER BY ID DESC",(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});


/**
 * 接口：/pushMessage
 * UI位置：留言板
 * 功能：读取前台POST来的表单信息（用户留言），把表单信息添加到数据库里的message_table
 * 效果：让“留言板”添加新留言
 */
server.post('/pushMessage', function(req, res){
    var userID=req.body.userID;
    var username=req.body.username;
    var avatar=req.body.avatar;
    var message=req.body.message;
    var email='';

    db.query(`INSERT INTO message_table (user_id,user_name,user_avatar,message,user_email) VALUE ('${userID}','${username}','${avatar}','${message}','${email}')`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});

server.post('/vsr_pushMessage', function(req, res){
    var userID=0;
    var username=req.body.username;
    var avatar='vister';
    var message=req.body.message;
    var email=req.body.email;

    db.query(`INSERT INTO message_table (user_id,user_name,user_avatar,message,user_email) VALUE ('${userID}','${username}','${avatar}','${message}','${email}')`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});


/**
 * 接口：/userReg
 * UI位置：留言板
 * 功能：读取前台POST来的表单信息（用户注册信息），把表单信息添加到数据库里的user_table
 * 效果：实现用户注册功能
 */
server.post('/userReg', function(req, res){
    let avatar=req.body.avatar;
    let signature=req.body.signature;


    let username=req.body.username;
    let email=req.body.email;

    //服务器接收到数据后再进行md5处理
    let md=forge.md.md5.create();
    md.update('一个人的命运啊，当然要靠自我奋斗，'+req.body.password+'但是也要考虑到历史的行程')
    let password=md.digest().toHex()

    if( username && password && signature && email ){

        db.query(`INSERT INTO user_table (username,password,signature,avatar,email) VALUE ('${username}','${password}','${signature}','${avatar}','${email}')`,(err,data)=>{
            if(err){
                console.error(err);
                res.status(500).send(err).end();
            }else{

                res.status(200).end();

            }
        });
    }
    else{
        console.log('reg fail')
    }

});


/**
 * 接口：/userLogin
 * UI位置：留言板
 * 功能：读取前台POST来的表单信息（用户登陆信息），再跟数据库里的user_table进行账号密码的比对，如果比对正确，在服务器种一个session
 * 效果：实现用户登陆功能
 */
server.post('/userLogin', function(req, res){
    var username=req.body.username;

    let md=forge.md.md5.create();
    md.update('一个人的命运啊，当然要靠自我奋斗，'+req.body.password+'但是也要考虑到历史的行程')
    let password=md.digest().toHex()


    db.query(`SELECT * FROM user_table WHERE username='${username}'`,(err,data)=>{
        if(err){
            console.error(err);
            var response = {
                message: "数据库发生错误，请稍后再试"
            }
            res.json(response).end();

        }else{
            if (username && data && data[0].username==username && data[0].password==password ) {
                var response = {
                    message: "登陆成功"
                }
                req.session['ID']=data[0].ID;
                res.json(response);
            }
            else{
                var response = {
                    message: "账户或密码错误"
                }
                res.json(response);
            }






            res.status(200).end();

        }
    });
});



/**
 * 接口：/getUserLogin
 * UI位置：留言板
 * 功能：当用户切换到留言板界面时，自动向服务器查询是否有相对于的session，如果有从user_table读取该用户信息返回前台，否则返回‘unLogin’字符串
 * 效果：实现用户账号验证功能
 */
server.get('/getUserLogin', (req, res)=>{


    if(req.session['ID']){

        let id=req.session['ID'];

        db.query(`SELECT * FROM user_table WHERE ID='${id}'`,(err,data) =>{
            if(err){
                console.log(err);
            }else{
                res.json(data)
            }
        });

    }
    else{
        res.json('unLogin');
    }



});


/**
 * 接口：/userLogOut
 * UI位置：留言板
 * 功能：跟服务器请求撤销掉该用户的session
 * 效果：实现用户账号下线功能
 */
server.get('/userLogOut', (req, res)=>{
    req.session['ID'] = null;
    res.status(200).end();
});





/**
 * 接口：/adminlogin
 * UI位置：留言板
 * 功能：读取前台POST来的表单信息（管理员登陆信息），再跟数据库里的adminusers进行账号密码的比对，如果比对正确，在服务器种一个session
 * 效果：实现管理员登陆功能
 */
server.post('/adminlogin', function(req, res){
    var username=req.body.username;

    let md=forge.md.md5.create();
    md.update('一个人的命运啊，当然要靠自我奋斗，'+req.body.password+'但是也要考虑到历史的行程')
    let password=md.digest().toHex()

    db.query(`SELECT * FROM adminusers`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{

            if (data[0].admin_username==username && data[0].admin_password==password ) {
                req.session['name']=data[0].admin_username;
            }
            else{
                console.log("login fail")
                res.json('adminfail');
            }

            //res.json(data);

            res.status(200).end();

        }
    });
});

/**
 * 接口：/adminLogOut
 * UI位置：留言板
 * 功能：跟服务器请求撤销掉该管理员的session
 * 效果：实现管理员账号下线功能
 */
server.get('/adminLogOut', (req, res)=>{
    req.session['name'] = null;
    res.status(200).end();
});










/************************************后台界面*******************************************/

/**
 * 接口：delArticleList
 * UI位置：后台==》删除文章
 * 功能：从数据库里的article_title读取所有文章的ID（文章ID），article_title（文章标题），并返回到请求端
 * 效果：让“后台==》删除文章”界面列出所有文章的id和文章标题
 */
server.get('/delArticleList', (req, res)=>{
    db.query("SELECT ID,article_title FROM article_table",(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});



/**
 * 接口：getUserList
 * UI位置：后台==》用户管理
 * 功能：从数据库里的user_table读取所有用户的ID（用户ID），username（用户名），email（用户邮件）并返回到请求端
 * 效果：让“后台==》删除文章”界面列出所有文章的id和文章标题
 */
server.get('/getUserList', (req, res)=>{
    db.query("SELECT ID,username,email FROM user_table ORDER BY ID DESC",(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});


/**
 * 接口：getMessageList
 * UI位置：后台==》管理留言
 * 功能：从数据库里的message_table读取所有留言的ID（留言ID），user_name（发留言用户名），message（留言内容）并返回到请求端
 * 效果：让“后台==》管理留言”界面列出所有留言的留言ID、发留言用户名留言内容
 */
server.get('/getMessageList', (req, res)=>{
    db.query("SELECT ID,user_name,message FROM message_table ORDER BY ID DESC",(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});











/**
 * 接口：/delArticle
 * UI位置：后台=》删除文章
 * 功能：读取前台发上来的ID，从数据库里的article_table删除该ID的所有内容
 * 效果：让“后台=》删除文章”这个界面删除某个文章的所有内容
 */
server.post('/delArticle', (req, res)=>{
    var id=req.body.id;
    db.query(`DELETE  FROM article_table WHERE ID=${id}`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});



/**
 * 接口：/delUser
 * UI位置：后台=》管理用户
 * 功能：读取前台发上来的ID，从数据库里的user_table删除该ID的所有内容
 * 效果：让“后台=》管理用户”这个界面删除某个用户的所有内容
 */
server.post('/delUser', (req, res)=>{

    var id=req.body.id;


    db.query(`DELETE  FROM user_table WHERE ID=${id}`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{

            res.status(200).end();
        }
    });
});


/**
 * 接口：/delMessage
 * UI位置：后台=》管理留言
 * 功能：读取前台发上来的ID，从数据库里的message_table删除该ID的所有内容
 * 效果：让“后台=》管理留言”这个界面删除某个留言
 */
server.post('/delMessage', (req, res)=>{

    var id=req.body.id;


    db.query(`DELETE  FROM message_table WHERE ID=${id}`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{

            res.status(200).end();
        }
    });
});




/**
 * 接口：/addArticle
 * UI位置：后台=》添加文章
 * 功能：读取前台POST来的表单信息，把表单信息添加到数据库里的article_table
 * 效果：让“后台=》添加文章”添加新文章
 */
server.post('/addArticle', function(req, res){
    var title=req.body.title;
    var type=req.body.type;
    var summary=req.body.summary;
    var context=req.body.context;


    db.query(`INSERT INTO article_table (article_title,article_summary,article_type,article_context) VALUE ('${title}','${summary}','${type}','${context}')`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});







/**
 * 接口：/getAdminLogin
 * UI位置：后台
 * 功能：当用户切换到后台界面时，自动向服务器查询是否有相对于的session，如果有从user_table读取该用户信息返回前台，否则返回‘fail’字符串
 * 效果：实现管理员账号验证功能
 */
server.get('/getAdminLogin', (req, res)=>{

    if(req.session['name']){
        res.json('success');
    }
    else{
        res.json('fail');
    }

    res.status(200).end();

});







/**
 * 接口：/updatePassword
 * UI位置：后台=》管理用户
 * 功能：接受前台post来的表单信息（用户id和最新用户密码），update user_table的对应用户密码
 * 效果：实现管理员更改用户密码功能
 */
server.post('/updatePassword', function(req, res){

    let id=req.body.id;

    let md=forge.md.md5.create();
    md.update('一个人的命运啊，当然要靠自我奋斗，'+req.body.password+'但是也要考虑到历史的行程')
    let password=md.digest().toHex()



    db.query(`UPDATE user_table SET 
    
    password='${password}'
   
    WHERE ID='${id}'`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).send('更新成功').end();
        }
    });
});



/**
 * 接口：/updateUserInfo
 * UI位置：后台=》管理用户
 * 功能：接受前台post来的表单信息（用户id和用户其他信息），update user_table的对应用户信息
 * 效果：实现管理员更改用户信息功能
 */
server.post('/updateUserInfo', function(req, res){
    var id=req.body.id;
    var avatar=req.body.avatar;
    var username=req.body.username;
    var signature=req.body.signature;



    db.query(`UPDATE user_table SET 
    avatar='${avatar}',
    username='${username}',
    signature='${signature}'
   
    WHERE ID='${id}'`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).send('update success').end();
        }
    });
});

/**
 * 接口：updateArticleList'
 * UI位置：首页
 * 功能：从数据库里的article_table读取所有留言的ID（文章ID），article_title（文章标题），
 *      article_summary（文章简介），article_push_time（文章发表时间）并返回到请求端
 * 效果：让“首页”界面列出所有文章标题、文章简介和文章发表时间
 */
server.get('/updateArticleList', (req, res)=>{
    db.query("SELECT ID,article_title,article_summary,article_push_time FROM article_table ORDER BY ID DESC",(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});




/**
 * 接口：/updateArticle
 * UI位置：后台=》修改文章
 * 功能：接受前台post来的表单信息（文章id和文章其他信息），update article_table的对应文章信息
 * 效果：实现管理员更改文章内容功能
 */
server.post('/updateArticle', function(req, res){
    var id=req.body.id;
    var title=req.body.title;
    var type=req.body.type;
    var summary=req.body.summary;
    var context=req.body.context;

    db.query(`UPDATE article_table SET 
    article_title='${title}',
    article_summary='${summary}',
    article_type='${type}',
    article_context='${context}'
    WHERE ID='${id}'`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).send('update success').end();
        }
    });
});




//没有了！！！

server.post('/blogImage', function(req, res){

    var ext=pathLib.parse(req.files[0].originalname).ext;
    var oldPath=req.files[0].path;
    var newPath=req.files[0].path+ext;
    var newFileName=req.files[0].filename+ext;
    fs.rename(oldPath,newPath,(err)=>{
        if(err){
            res.status(500).send('fail fs').end();
        }
    })

    var url='apis/'+newPath

    url=url.replace(/\\/g,'/')

    res.json(url)
});

















server.get('/getShareList', (req, res)=>{
    var id=req.query.tabid;
        db.query(`SELECT ID,share_title FROM share_table  ORDER BY ID DESC`,(err,data)=>{
            if(err){
                console.error(err);
                res.status(500).send(err).end();
            }else{
                res.json(data);
            }
        });
});



/**
 * 接口：/Shares
 * UI位置：文章 || 后台=》修改文章
 * 功能：读取前台发上来的ID，从数据库里的article_title读取该ID的所有内容，并返回到请求端
 * 效果：让“文章 || 后台=》修改文章”这两个界面列出某个文章的所有内容
 */
server.get('/getShares', (req, res)=>{
    var id=req.query.id;
    db.query(`SELECT * FROM share_table WHERE ID=${id} ORDER BY ID DESC`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});



/**
 * 接口：/addShare
 * UI位置：后台=》添加文章
 * 功能：读取前台POST来的表单信息，把表单信息添加到数据库里的article_table
 * 效果：让“后台=》添加文章”添加新文章
 */
server.post('/addShare', function(req, res){
    var title=req.body.title;
    var context=req.body.context;


    db.query(`INSERT INTO share_table (share_title,share_context) VALUE ('${title}','${context}')`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});


/**
 * 接口：/updateShare
 * UI位置：后台=》修改文章
 * 功能：接受前台post来的表单信息（文章id和文章其他信息），update article_table的对应文章信息
 * 效果：实现管理员更改文章内容功能
 */
server.post('/updateShare', function(req, res){
    var id=req.body.id;
    var title=req.body.title;
    var context=req.body.context;

    db.query(`UPDATE share_table SET 
    share_title='${title}',
    share_context='${context}'
    WHERE ID='${id}'`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).send('update success').end();
        }
    });
});


server.post('/delShare', (req, res)=>{
    var id=req.body.id;
    db.query(`DELETE  FROM share_table WHERE ID=${id}`,(err,data)=>{
        if(err){
            console.error(err);
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});




server.get('/getComment', (req, res)=>{

    var id=req.query.id;

    db.query(`SELECT * FROM comment_table WHERE article_id=${id} ORDER BY ID DESC`,(err,data)=>{
        if(err){
            console.log(err);
            res.status(500).send(err).end();
        }else{
            res.json(data);
        }
    });
});


server.post('/pushComment', function(req, res){
    var aID=req.body.aID;
    var userID=req.body.userID;
    var username=req.body.username;
    var avatar=req.body.avatar;
    var comment=req.body.comment;


    db.query(`INSERT INTO comment_table (article_id,user_id,user_name,user_avatar,comment) VALUE ('${aID}','${userID}','${username}','${avatar}','${comment}')`,(err,data)=>{
        if(err){
            console.error();
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});


server.post('/vsr_pushComment', function(req, res){
    var aID=req.body.aID;
    var userID=0;
    var username=req.body.username;
    var avatar='vister';
    var comment=req.body.message;
    var email=req.body.email


    db.query(`INSERT INTO comment_table (article_id,user_id,user_name,user_avatar,comment,email) VALUE ('${aID}','${userID}','${username}','${avatar}','${comment}','${email}')`,(err,data)=>{
        if(err){
            console.error();
            res.status(500).send(err).end();
        }else{
            res.status(200).end();
        }
    });
});


